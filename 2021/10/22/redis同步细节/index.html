<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Redis 主从同步细节 - 大白的碎碎念</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="bwangel" /><meta name="description" content=" 介绍了 Redis 的主从同步流程及一些配置选项
" /><meta name="keywords" content="Hugo, blog, bwangel" />






<meta name="generator" content="Hugo 0.83.1 with theme even" />


<link rel="canonical" href="/2021/10/22/redis%E5%90%8C%E6%AD%A5%E7%BB%86%E8%8A%82/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link href="https://cdn.bootcdn.net/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.css" crossorigin="anonymous" rel="stylesheet">


<meta property="og:title" content="Redis 主从同步细节" />
<meta property="og:description" content="
介绍了 Redis 的主从同步流程及一些配置选项
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2021/10/22/redis%E5%90%8C%E6%AD%A5%E7%BB%86%E8%8A%82/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-10-22T21:57:55&#43;08:00" />
<meta property="article:modified_time" content="2021-10-22T21:57:55&#43;08:00" />

<meta itemprop="name" content="Redis 主从同步细节">
<meta itemprop="description" content="
介绍了 Redis 的主从同步流程及一些配置选项
"><meta itemprop="datePublished" content="2021-10-22T21:57:55&#43;08:00" />
<meta itemprop="dateModified" content="2021-10-22T21:57:55&#43;08:00" />
<meta itemprop="wordCount" content="1808">
<meta itemprop="keywords" content="redis," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis 主从同步细节"/>
<meta name="twitter:description" content="
介绍了 Redis 的主从同步流程及一些配置选项
"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Keep Foolish</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/tips/">
        <li class="mobile-menu-item">Tips</li>
      </a><a href="/leetcode/">
        <li class="mobile-menu-item">LeetCode</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/translate/">
        <li class="mobile-menu-item">翻译</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Keep Foolish</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tips/">Tips</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/leetcode/">LeetCode</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/translate/">翻译</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Redis 主从同步细节</h1>

      <div class="post-meta">
        <span class="post-time"> 2021-10-22 </span>
        
          <span class="more-meta"> 约 1808 字 </span>
          <span class="more-meta"> 预计阅读 4 分钟 </span>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#完整的复制流程">完整的复制流程</a></li>
        <li><a href="#复制过程中的参数说明">复制过程中的参数说明</a>
          <ul>
            <li><a href="#full-resynchronization-全量复制">Full Resynchronization (全量复制)</a></li>
          </ul>
        </li>
        <li><a href="#在线更新">在线更新</a></li>
        <li><a href="#部分复制-partial-resynchronization">部分复制 (partial resynchronization)</a></li>
        <li><a href="#无盘化复制">无盘化复制</a></li>
        <li><a href="#降低数据不一致出现的概率">降低数据不一致出现的概率</a>
          <ul>
            <li><a href="#因-master-挂掉出现数据不一致">因 master 挂掉出现数据不一致</a></li>
            <li><a href="#因集群脑裂出现数据不一致">因集群脑裂出现数据不一致</a></li>
          </ul>
        </li>
        <li><a href="#过期-key-处理">过期 key 处理</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <blockquote>
<p>介绍了 Redis 的主从同步流程及一些配置选项</p>
</blockquote>
<hr>
<h2 id="完整的复制流程">完整的复制流程</h2>
<ol>
<li>slave 启动，获取 master 节点的信息，包括 (master run_id)</li>
<li>如果 slave 中可以找到此 master 的数据，发送 <code>PSYNC {master run id} {slave offset}</code> 指令给 master，请求开始部分复制。</li>
<li>如果 slave 找不到 master 的数据，发送 <code>PSYNC ? -1</code> 指令给 master，请求全量复制。</li>
<li>口令认证，如果 master 设置了 <code>requirepass</code>，slave 节点必须发送 <code>masterauth</code> 设置的口令去认证</li>
<li>master node 执行一次全量复制/部分复制，将数据同步到 slave 上。</li>
<li>master node 后续持续将写命令，异步地发送给 slave，同时会将命令写入到先进先出的队列 backlog 中</li>
</ol>
<p>主从复制的流程图如下</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-10-22-143417.png" alt=""></p>
<h2 id="复制过程中的参数说明">复制过程中的参数说明</h2>
<ul>
<li>offset (复制偏移量)</li>
</ul>
<p>master 和  slave 都会维护一个累加的 offset，master 还会维护每个 slave 的offset，用于沟通数据的差异。</p>
<p><code>role</code>命令可以查看复制偏移量</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># master role</span>
127.0.0.1:6379&gt; role
1<span class="o">)</span> <span class="s2">&#34;master&#34;</span>  <span class="c1"># 服务器的角色</span>
2<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> <span class="m">98</span>  <span class="c1"># master 的复制偏移量</span>
3<span class="o">)</span> 1<span class="o">)</span> 1<span class="o">)</span> <span class="s2">&#34;127.0.0.1&#34;</span>  <span class="c1"># slave host</span>
      2<span class="o">)</span> <span class="s2">&#34;6380&#34;</span>   <span class="c1"># slave port</span>
      3<span class="o">)</span> <span class="s2">&#34;98&#34;</span>     <span class="c1"># slave 的复制偏移量</span>

<span class="c1"># slave role</span>
127.0.0.1:6380&gt; role
1<span class="o">)</span> <span class="s2">&#34;slave&#34;</span>  <span class="c1"># 服务器的角色</span>
2<span class="o">)</span> <span class="s2">&#34;localhost&#34;</span>  <span class="c1"># master host</span>
3<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> <span class="m">6379</span>  <span class="c1"># master port</span>
4<span class="o">)</span> <span class="s2">&#34;connected&#34;</span>  <span class="c1"># 和 master 的连接状态</span>
5<span class="o">)</span> <span class="o">(</span>integer<span class="o">)</span> <span class="m">112</span>  <span class="c1"># slave 的复制偏移量</span>
</code></pre></td></tr></table>
</div>
</div><p>连接状态有以下几种值:</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ldquo;none&rdquo;</td>
<td>主从服务器尚未建立连接</td>
</tr>
<tr>
<td>&ldquo;connect&rdquo;</td>
<td>主从服务器正在握手。</td>
</tr>
<tr>
<td>&ldquo;connecting&rdquo;</td>
<td>主从服务器成功建立了连接。</td>
</tr>
<tr>
<td>&ldquo;sync&rdquo;</td>
<td>主从服务器正在进行数据同步。</td>
</tr>
<tr>
<td>&ldquo;connected&rdquo;</td>
<td>主从服务器已经进入在线更新状态。</td>
</tr>
<tr>
<td>&ldquo;unknown&rdquo;</td>
<td>主从服务器连接状态未知。</td>
</tr>
</tbody>
</table>
<ul>
<li>run id</li>
</ul>
<p>master run id 发生变化时， slave 会重新做全量复制</p>
<p>使用 <code>info server</code> 可以查看当前 Redis Server 的 run id</p>
<h3 id="full-resynchronization-全量复制">Full Resynchronization (全量复制)</h3>
<ol>
<li>master 执行 bgsave，用子进程生成 rdb 快照文件</li>
<li>master 生成快照文件的同时会将随后的操作指令写在内存缓存中</li>
<li>master 将 rdb 文件发送给 slave node，如果发送时间超过 <code>repl-timeout</code> （默认是 60s），那么 slave node 就会认为复制失败，可以适当调大这个参数.</li>
<li><code>client-output-buffer-limit slave 256M 64M 60</code>，如果在复制过程中，内存缓存区持续消耗超过 64M，或一次性超过 256M，那么停止复制，复制失败。</li>
<li>slave 将 rdb 文件落盘</li>
<li>slave 从 rdb 文件恢复数据，恢复的同时基于旧数据 serve</li>
<li>如果 slave 开启了 aof 备份，那么恢复成功后会立即执行 BGREWRITEAOF，重写 AOF</li>
<li>master 在 slave 恢复成功后将内存缓存的操作指令发送给 slave</li>
</ol>
<blockquote>
<p><strong>在数据同步时复用 rdb 文件</strong></p>
<ol>
<li>如果 master 在收到 replicaof 指令之前已经执行过一次 bgsave 命令，且数据库在执行 bgsave 之后没有任何变化，那么 master 将会直接向 slave 发送已经生成的 rdb 文件</li>
<li>如果 master 在生成 rdb 文件期间，又有多个 slave 请求同步数据，那么 master 会把请求同步的 slave 全部放到队列中，等 rdb 文件生成后，一起发送给队列中的所有 slave</li>
</ol>
</blockquote>
<h2 id="在线更新">在线更新</h2>
<p>master 和 slave 执行完全量复制后，</p>
<ol>
<li>master 会将收到的写指令发送给 slave 执行，让两边数据同步</li>
<li>master 对每个 slave 都会维护一个先进先出的队列，存储 slave 收到的写指令。可以通过 <code>repl-backlog-size</code> 设置这个队列的大小</li>
</ol>
<h2 id="部分复制-partial-resynchronization">部分复制 (partial resynchronization)</h2>
<ol start="0">
<li>在 redis 2.8 之前，如果 slave 断开连接后又重新建立连接，slave 会请求重新执行一次全量同步，这样非常浪费资源</li>
<li>redis 2.8 之后，添加了部分复制的功能</li>
<li>第一次全量复制完成后，master 每次向 slave 发送的指令都会存储到 backlog 中</li>
<li>如果 slave 因为网络原因短暂地断开了连接， slave 重新连接后会发送 replica offset 到 master 中</li>
<li>master 如果在 backlog 中找到了 replica offset，master 会将 backlog 中存储的剩余数据发送过来。</li>
<li>如果找不到，master 会开始进行全量复制</li>
</ol>
<blockquote>
<p>backlog 的容量越大，master 所能容忍的 slave 断线时间也就越长，可以通过 <code>repl-backlog-size</code> 选项更改 backlog 的大小。</p>
</blockquote>
<h2 id="无盘化复制">无盘化复制</h2>
<p>两个相关选项:</p>
<ul>
<li>repl-diskless-sync</li>
</ul>
<p>开启此选项后，rdb 文件在 master 上不会落盘，会直接发送给 slave，slave 上还是会进行落盘，redis 目前无法做到完全不依靠硬盘实现主从复制。</p>
<ul>
<li>repl-diskless-sync-delay</li>
</ul>
<p>开启无盘化复制后，新的 Slave 无法复用之前已经开始的复制任务，只能等待新的复制任务。<code>repl-diskless-sync-delay</code> 设置复制任务在收到 Slave 的请求多久后开始，以等待更多的 Slave 连接，一起发送 rdb 数据。</p>
<h2 id="降低数据不一致出现的概率">降低数据不一致出现的概率</h2>
<h3 id="因-master-挂掉出现数据不一致">因 master 挂掉出现数据不一致</h3>
<ol>
<li>master 将数据同步到 slave 是异步进行的，如果 master 还有部分数据未同步，就挂掉了。哨兵发现 master 不正常，及时切换了 master，但旧 master 中未同步的数据就会丢失掉了。</li>
<li>设置 <code>min-slaves-max-lag 10</code> 选项，表示如果超过10秒 slave 没有和 master 通信过，master 就认为 slave 和自己的数据差别太大，不再接收写操作。这样 master 挂掉后可以少丢失一些数据。</li>
</ol>
<h3 id="因集群脑裂出现数据不一致">因集群脑裂出现数据不一致</h3>
<ol>
<li>因为网络原因，集群短暂地分裂成两个，两个 master 都接收数据。网络恢复后，节点少的 master 会重新变成 slave，此时这个 master 上写的数据就会丢失。</li>
<li>设置 <code>min-slaves-to-write 3</code> 选项，表示如果 slave 个数小于3，master 就不再接收写操作，小集群的 master 不写数据，集群恢复后，也不会造成数据丢失。</li>
</ol>
<h2 id="过期-key-处理">过期 key 处理</h2>
<p>如果设置了 <code>slave-read-only=yes</code>， Slave 不会主动过期 key，master 在将 key 过期后，会发送 DEL 指令给 Slave</p>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">bwangel</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2021-10-22
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">许可协议</span>
    <span class="item-content">本博客所有文章除特别声明外，均采用 <a href='http://creativecommons.org/licenses/by-nc-sa/3.0/cn/' rel='external nofollow' target='_blank'>CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/redis/">redis</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/2022/01/12/go_gcflags/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Go gcflags/ldflags 的说明</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/2021/05/22/docker-client-remote-server/">
            <span class="next-text nav-default">Docker 客户端连接远程 Docker Daemon</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  
    <script src="https://utteranc.es/client.js"
            repo="anotherbwangel/blog-comment"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/utterance">comments powered by utterances.</a></noscript>

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:bwangel.me@email.com" class="iconfont icon-email" title="email"></a>
      <a href="https://stackoverflow.com/users/5161084/bwangel" class="iconfont icon-stack-overflow" title="stack-overflow"></a>
      <a href="https://twitter.com/bwangel23" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/bwangelme" class="iconfont icon-github" title="github"></a>
      <a href="https://www.douban.com/people/bwangel/" class="iconfont icon-douban" title="douban"></a>
  <a href="/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2016 - 
    2022<span class="heart"><i class="iconfont icon-heart"></i></span><span><a href='https://bwangel.me/about'>bwangel</a></span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.2.1/jquery.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/slideout/1.0.1/slideout.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.bootcdn.net/ajax/libs/fancybox/3.1.20/jquery.fancybox.min.js" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        tags: 'ams',
        }
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3.0.5/es5/tex-mml-chtml.js" integrity="sha256-HGLuEfFcsUJGhvB8cQ8nr0gai9EucOOaIxFw7qxmd+w=" crossorigin="anonymous"></script>

<script id="baidu_analytics">
  var _hmt = _hmt || [];
  (function() {
    if (window.location.hostname === 'localhost') return;
    var hm = document.createElement("script"); hm.async = true;
    hm.src = "https://hm.baidu.com/hm.js?f22fe9c7aece3dedec2af9976b092478";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
  })();
</script>






</body>
</html>
