---
title: "《k8s in actions》第十章杂记"
date: 2022-01-18T10:11:27+08:00
lastmod: 2022-01-18T10:11:27+08:00
draft: false
tags: [kubernetes, 杂记]
author: "bwangel"
comment: true

---

<!--more-->
---

## 杂记

- StatefulSet 用于创建有状态的服务，StatefulSet 创建的每个 Pod 都有一个从0开始的顺序索引，这个会体现在 Pod 的名称，主机名和存储上。

- Pod 挂掉后，这个 Pod 实例会在另一个节点上重建，且新的实例必须和被替换的示例有如下相同的标识:

    1. 相同的名称
    2. 相同的网络标识(主机名/IP)
    3. 相同的状态

- StatefulSet 的每个 Pod 都会创建一个持久卷声明(Persistent Volume Claim)。
  - 对 StatefulSet 执行缩容后，Pod 会被删除，但是它对应的持久卷声明不会删除，卷也不会删。需要开发者手动删除 PVC 时卷才会被删除。
  后续对 StatefulSet 执行扩容后，该索引的 Pod 又被创建了，则新 Pod 会使用之前遗留的卷。

- StatefulSet 保证 Pod 的 at-most-one 语义，即同一个索引的 Pod 最多只会创建一个。
- 删除 Pod 后，API Server 会将 Pod 标记为 Terminating 状态，使用 `k get pod` 依然能够查询到该 Pod。这是因为 API Server 必须等到 kubelet 报告该 Pod 处于删除状态后，API Server 才会真正删除 Pod 的信息。
  - 如果整个节点都挂了，确认该 Pod 已经无用了，可以使用 `k delete pod xx --force --grace-period 0` 删除该 Pod。这样 API Server 就不会等待 kubelet 的等待，直接删除 Pod 的信息

## 创建 StatefulSet 服务

创建服务时，启动 pod 出现了如下的错误:

```shell
Events:
  Type     Reason                  Age                   From               Message
  ----     ------                  ----                  ----               -------
  Warning  FailedScheduling        3m16s                 default-scheduler  0/3 nodes are available: 3 pod has unbound immediate PersistentVolumeClaims.
  Normal   Scheduled               3m15s                 default-scheduler  Successfully assigned default/kubia-0 to k8s-node3
  Warning  FailedCreatePodSandBox  3m15s                 kubelet            Failed to create pod sandbox: rpc error: code = Unknown desc = [failed to set up sandbox container "96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d" network for pod "kubia-0": networkPlugin cni failed to set up pod "kubia-0_default" network: unable to allocate IP address: Post "http://127.0.0.1:6784/ip/96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d": dial tcp 127.0.0.1:6784: connect: connection refused, failed to clean up sandbox container "96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d" network for pod "kubia-0": networkPlugin cni failed to teardown pod "kubia-0_default" network: Delete "http://127.0.0.1:6784/ip/96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d": dial tcp 127.0.0.1:6784: connect: connection refused]
  Normal   SandboxChanged          10s (x15 over 3m14s)  kubelet            Pod sandbox changed, it will be killed and re-created.
```
